// ============================================================================
// ALUNAINFINITY - PRISMA SCHEMA
// Este archivo ser√° usado en el backend
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTH
// ============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  phone         String?
  role          UserRole  @default(CUSTOMER)
  emailVerified Boolean   @default(false) @map("email_verified")
  isActive      Boolean   @default(true) @map("is_active")
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  addresses      Address[]
  orders         Order[]
  carts          Cart[]
  reviews        Review[]
  wishlists      Wishlist[]
  notifications  Notification[]
  inventoryLogs  InventoryLog[]
  couponUsages   CouponUsage[]

  @@index([email])
  @@index([role])
  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

model Address {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  addressLine1 String   @map("address_line1")
  addressLine2 String?  @map("address_line2")
  city         String
  state        String
  postalCode   String?  @map("postal_code")
  country      String   @default("Colombia")
  phone        String?
  isDefault    Boolean  @default(false) @map("is_default")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

// ============================================================================
// PRODUCTS & CATALOG
// ============================================================================

model Category {
  id           String     @id @default(uuid())
  name         String
  slug         String     @unique
  description  String?
  imageUrl     String?    @map("image_url")
  parentId     String?    @map("parent_id")
  displayOrder Int        @default(0) @map("display_order")
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Self-relation for subcategories
  parent   Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children Category[] @relation("CategoryToCategory")

  // Relations
  products Product[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Product {
  id                 String   @id @default(uuid())
  name               String
  slug               String   @unique
  description        String?
  shortDescription   String?  @map("short_description")
  price              Decimal  @db.Decimal(10, 2)
  comparePrice       Decimal? @map("compare_price") @db.Decimal(10, 2)
  costPrice          Decimal? @map("cost_price") @db.Decimal(10, 2)
  categoryId         String?  @map("category_id")
  sku                String?  @unique
  barcode            String?
  images             Json     @default("[]")
  stockQuantity      Int      @default(0) @map("stock_quantity")
  lowStockThreshold  Int      @default(5) @map("low_stock_threshold")
  trackInventory     Boolean  @default(true) @map("track_inventory")
  weight             Decimal? @db.Decimal(10, 2)
  dimensions         Json?
  metaTitle          String?  @map("meta_title")
  metaDescription    String?  @map("meta_description")
  isActive           Boolean  @default(true) @map("is_active")
  isFeatured         Boolean  @default(false) @map("is_featured")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  category       Category?        @relation(fields: [categoryId], references: [id])
  variants       ProductVariant[]
  orderItems     OrderItem[]
  inventoryLogs  InventoryLog[]
  reviews        Review[]
  wishlists      Wishlist[]

  @@index([slug])
  @@index([categoryId])
  @@index([sku])
  @@index([isActive])
  @@index([isFeatured])
  @@index([price])
  @@map("products")
}

model ProductVariant {
  id            String   @id @default(uuid())
  productId     String   @map("product_id")
  name          String
  sku           String   @unique
  barcode       String?
  price         Decimal? @db.Decimal(10, 2)
  comparePrice  Decimal? @map("compare_price") @db.Decimal(10, 2)
  stockQuantity Int      @default(0) @map("stock_quantity")
  attributes    Json     @default("{}") // {size: "M", color: "Rosa"}
  imageUrl      String?  @map("image_url")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]
  inventoryLogs InventoryLog[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model InventoryLog {
  id             String          @id @default(uuid())
  productId      String?         @map("product_id")
  variantId      String?         @map("variant_id")
  changeType     String          @map("change_type") // sale, restock, adjustment, return
  quantityChange Int             @map("quantity_change")
  quantityAfter  Int             @map("quantity_after")
  reason         String?
  userId         String?         @map("user_id")
  createdAt      DateTime        @default(now()) @map("created_at")

  // Relations
  product Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  user    User?           @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([variantId])
  @@index([createdAt])
  @@map("inventory_logs")
}

// ============================================================================
// ORDERS
// ============================================================================

model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique @map("order_number")
  userId          String?       @map("user_id")
  status          OrderStatus   @default(PENDING)
  subtotal        Decimal       @db.Decimal(10, 2)
  shippingCost    Decimal       @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  discountAmount  Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  paymentMethod   String?       @map("payment_method")
  paymentStatus   PaymentStatus @default(PENDING) @map("payment_status")
  paymentId       String?       @map("payment_id")
  paidAt          DateTime?     @map("paid_at")
  shippingAddress Json          @map("shipping_address")
  shippingMethod  String?       @map("shipping_method")
  trackingNumber  String?       @map("tracking_number")
  shippedAt       DateTime?     @map("shipped_at")
  deliveredAt     DateTime?     @map("delivered_at")
  couponCode      String?       @map("coupon_code")
  customerNotes   String?       @map("customer_notes")
  adminNotes      String?       @map("admin_notes")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  user         User?         @relation(fields: [userId], references: [id])
  items        OrderItem[]
  couponUsages CouponUsage[]

  @@index([orderNumber])
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PROCESSING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model OrderItem {
  id           String          @id @default(uuid())
  orderId      String          @map("order_id")
  productId    String?         @map("product_id")
  variantId    String?         @map("variant_id")
  productName  String          @map("product_name")
  variantName  String?         @map("variant_name")
  sku          String?
  unitPrice    Decimal         @map("unit_price") @db.Decimal(10, 2)
  quantity     Int
  total        Decimal         @db.Decimal(10, 2)
  productImage String?         @map("product_image")
  createdAt    DateTime        @default(now()) @map("created_at")

  // Relations
  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product?        @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ============================================================================
// CART
// ============================================================================

model Cart {
  id        String    @id @default(uuid())
  userId    String?   @map("user_id")
  sessionId String?   @map("session_id")
  items     Json      @default("[]")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([expiresAt])
  @@map("carts")
}

// ============================================================================
// COUPONS
// ============================================================================

model Coupon {
  id                    String    @id @default(uuid())
  code                  String    @unique
  description           String?
  discountType          String    @map("discount_type") // percentage, fixed
  discountValue         Decimal   @map("discount_value") @db.Decimal(10, 2)
  minPurchase           Decimal?  @map("min_purchase") @db.Decimal(10, 2)
  maxDiscount           Decimal?  @map("max_discount") @db.Decimal(10, 2)
  maxUses               Int?      @map("max_uses")
  timesUsed             Int       @default(0) @map("times_used")
  maxUsesPerUser        Int       @default(1) @map("max_uses_per_user")
  applicableProducts    Json?     @map("applicable_products")
  applicableCategories  Json?     @map("applicable_categories")
  validFrom             DateTime? @map("valid_from")
  validUntil            DateTime? @map("valid_until")
  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  usages CouponUsage[]

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

model CouponUsage {
  id             String   @id @default(uuid())
  couponId       String   @map("coupon_id")
  userId         String?  @map("user_id")
  orderId        String?  @map("order_id")
  discountAmount Decimal  @map("discount_amount") @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])
  order  Order? @relation(fields: [orderId], references: [id])

  @@index([couponId])
  @@index([userId])
  @@index([orderId])
  @@map("coupon_usages")
}

// ============================================================================
// REVIEWS
// ============================================================================

model Review {
  id                 String   @id @default(uuid())
  productId          String   @map("product_id")
  userId             String   @map("user_id")
  orderId            String?  @map("order_id")
  rating             Int // 1-5
  title              String?
  comment            String?
  isApproved         Boolean  @default(false) @map("is_approved")
  isVerifiedPurchase Boolean  @default(false) @map("is_verified_purchase")
  helpfulCount       Int      @default(0) @map("helpful_count")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
  @@index([isApproved])
  @@index([rating])
  @@map("reviews")
}

// ============================================================================
// WISHLIST
// ============================================================================

model Wishlist {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("wishlists")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// SETTINGS
// ============================================================================

model Setting {
  key         String   @id
  value       Json
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// ============================================================================
// EMAIL LOGS
// ============================================================================

model EmailLog {
  id           String   @id @default(uuid())
  toEmail      String   @map("to_email")
  subject      String
  template     String?
  status       String   @default("sent") // sent, failed, bounced
  errorMessage String?  @map("error_message")
  metadata     Json?
  sentAt       DateTime @default(now()) @map("sent_at")

  @@index([toEmail])
  @@index([sentAt])
  @@map("email_logs")
}

